---
Date: 2024-12-24
Category: Auth
---
# ğŸ› ï¸ **JWT + Redis ì¸ì¦ ì‹œìŠ¤í…œ ìµœì¢… êµ¬í˜„ ê³„íš**

## ğŸš€ **1. ëª©í‘œ ë° ìš”êµ¬ì‚¬í•­ ì •ë¦¬**

### âœ… **1.1 ëª©í‘œ**

1. **JWTë¥¼ HttpOnly Secure ì¿ í‚¤ì— ì €ì¥**í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì•ˆì „í•˜ê²Œ ë³´í˜¸
2. **Refresh Tokenì„ Redisì— ì €ì¥**í•˜ì—¬ ì¤‘ì•™ ì§‘ì¤‘ì‹ ê´€ë¦¬ ë° ê²€ì¦
3. **Refresh Token ê²€ì¦ ë¡œì§ êµ¬í˜„**
4. **Redis ìš´ì˜ ê´€ë¦¬:** í•˜ë£¨ì— í•œ ë²ˆ **ë°±ì—… íŒŒì¼ ìƒì„±**

---

## ğŸ“‘ **2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ (PlantUML)**

![[Pasted image 20241224122701.png]]

---

## âš™ï¸ **3. êµ¬í˜„ ì„¸ë¶€ì‚¬í•­**

### âœ… **3.1 JWTë¥¼ HttpOnly Secure ì¿ í‚¤ì— ì €ì¥**

**ğŸ›¡ï¸ ë³´ì•ˆ ì„¤ì • (Spring Boot ì˜ˆì œ)**

```java
ResponseCookie jwtCookie = ResponseCookie.from("accessToken", accessToken)
    .httpOnly(true)
    .secure(true)
    .sameSite("Strict")
    .path("/")
    .maxAge(Duration.ofHours(1)) // 1ì‹œê°„ ìœ íš¨
    .build();

response.addHeader("Set-Cookie", jwtCookie.toString());
```

**ì„¤ì • ëª©í‘œ:**

- `HttpOnly`: JavaScript ì ‘ê·¼ ë°©ì§€
- `Secure`: HTTPS ì „ì†¡ë§Œ í—ˆìš©
- `SameSite=Strict`: CSRF ê³µê²© ë°©ì§€
- `maxAge`: ì¿ í‚¤ ë§Œë£Œ ì‹œê°„

---

### âœ… **3.2 Refresh Tokenì„ Redisì— ì €ì¥**

**ğŸ—‚ï¸ RefreshToken Entity**

```java
import lombok.Getter;
import org.springframework.data.annotation.Id;
import org.springframework.data.redis.core.RedisHash;

@Getter
@RedisHash(value = "refreshToken", timeToLive = 86400) // 24ì‹œê°„
public class RefreshToken {

    @Id
    private String refreshToken;
    private Long userId;

    public RefreshToken(String refreshToken, Long userId) {
        this.refreshToken = refreshToken;
        this.userId = userId;
    }
}
```

**ğŸ“š Repository Interface**

```java
import org.springframework.data.repository.CrudRepository;

public interface RefreshTokenRepository extends CrudRepository<RefreshToken, String> {
}
```

**ğŸ›¡ï¸ Redis TTL ì„¤ì •:**

- TTL: 24ì‹œê°„
- Refresh Tokenì€ ë§Œë£Œ í›„ ìë™ ì‚­ì œ

---

### âœ… **3.3 Refresh Token ê²€ì¦**

**ğŸ”„ TokenService ì˜ˆì œ**

```java
@RequiredArgsConstructor
@Service
public class TokenService {
    private final RefreshTokenRepository refreshTokenRepository;
    private final TokenProvider tokenProvider;

    public String generateAccessToken(String refreshToken) {
        RefreshToken storedToken = refreshTokenRepository.findById(refreshToken)
            .orElseThrow(() -> new RuntimeException("Invalid Refresh Token"));

        return tokenProvider.createAccessToken(storedToken.getUserId());
    }
}
```

**ğŸ“Œ ê²€ì¦ íë¦„:**

1. í´ë¼ì´ì–¸íŠ¸ê°€ Refresh Tokenì„ ì„œë²„ì— ìš”ì²­.
2. ì„œë²„ëŠ” Redisì—ì„œ Refresh Tokenì„ ê²€ì¦.
3. ìœ íš¨í•œ ê²½ìš°, ìƒˆë¡œìš´ Access Token ë°œê¸‰.
4. ë¬´íš¨í•œ ê²½ìš°, ê°•ì œ ì¬ë¡œê·¸ì¸ ìš”êµ¬.

---

### âœ… **3.4 Redis ìš´ì˜ - ì£¼ê¸°ì  ë°±ì—…**

**ğŸ—ƒï¸ Redis RDB (Snapshot) ì„¤ì •**

#### ğŸ“Œ `redis.conf` ì„¤ì • ì˜ˆì‹œ:

```conf
save 86400 1  # 24ì‹œê°„ë§ˆë‹¤ 1ë²ˆ ìŠ¤ëƒ…ìƒ· ì €ì¥
dbfilename dump.rdb  # ë°±ì—… íŒŒì¼ ì´ë¦„
dir /var/lib/redis  # ë°±ì—… íŒŒì¼ ì €ì¥ ê²½ë¡œ
```

**ğŸ“Œ Spring Boot Scheduled Backup (ì˜µì…˜)**

```java
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

@Component
public class RedisBackupTask {

    @Scheduled(cron = "0 0 3 * * *") // ë§¤ì¼ ìƒˆë²½ 3ì‹œ ì‹¤í–‰
    public void backupRedis() {
        try {
            Runtime.getRuntime().exec("redis-cli SAVE");
            System.out.println("Redis backup completed successfully.");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**ğŸ“Œ ì„¤ëª…:**

- `save 86400 1`: 24ì‹œê°„ë§ˆë‹¤ Redis ìŠ¤ëƒ…ìƒ· ì €ì¥
- `cron`: ë§¤ì¼ ìƒˆë²½ 3ì‹œì— ê°•ì œ ë°±ì—… ì‹¤í–‰

---

## ğŸ›¡ï¸ **4. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­**

1. **ì¿ í‚¤ ì„¤ì • ê°•í™”:**
    - HttpOnly, Secure, SameSite=Strict í•„ìˆ˜
2. **Redis ë³´ì•ˆ ì„¤ì •:**
    - Redis ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
    - ì™¸ë¶€ ì ‘ê·¼ ì œí•œ (`bind 127.0.0.1`)
3. **ì£¼ê¸°ì  ëª¨ë‹ˆí„°ë§:**
    - Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
    - ë¡œê·¸ ë° ì ‘ê·¼ ê¸°ë¡ ë¶„ì„
4. **í† í° ë§Œë£Œ ì‹œê°„ ê´€ë¦¬:**
    - Access Token: ì§§ê²Œ (1ì‹œê°„)
    - Refresh Token: ê¸¸ê²Œ (24ì‹œê°„)

---

## ğŸ“Š **5. ìµœì¢… ì‹œìŠ¤í…œ íë¦„**

1. **ë¡œê·¸ì¸:** JWT (Access Token) â†’ HttpOnly Secure ì¿ í‚¤, Refresh Token â†’ Redis ì €ì¥
2. **Access Token ë§Œë£Œ:** Refresh Tokenìœ¼ë¡œ ìƒˆë¡œìš´ Access Token ë°œê¸‰ (Redis ê²€ì¦)
3. **ë¡œê·¸ì•„ì›ƒ:** Redisì—ì„œ Refresh Token ì‚­ì œ, ì¿ í‚¤ ë¬´íš¨í™”
4. **ê°•ì œ ë¡œê·¸ì•„ì›ƒ:** Redisì—ì„œ ì‚¬ìš©ìì˜ ëª¨ë“  Refresh Token ì‚­ì œ
5. **ë°±ì—…:** Redis ìŠ¤ëƒ…ìƒ·ì´ ë§¤ì¼ ìƒì„± ë° ì €ì¥

---

## ğŸ¯ **6. ê¸°ëŒ€ íš¨ê³¼**

âœ… **ë³´ì•ˆ ê°•í™”:**

- XSS, CSRF, í† í° íƒˆì·¨ ìœ„í—˜ ìµœì†Œí™”  
    âœ… **ì¤‘ì•™ ì§‘ì¤‘ì‹ ê´€ë¦¬:**
- Redisë¡œ Refresh Token ìƒíƒœ ê´€ë¦¬  
    âœ… **ìœ ì—°í•œ ìš´ì˜:**
- ê°•ì œ ë¡œê·¸ì•„ì›ƒ, í† í° ë¬´íš¨í™” ê°€ëŠ¥  
    âœ… **ì•ˆì •ì  ìš´ì˜:**
- ì¼ì¼ ë°±ì—…ìœ¼ë¡œ ë°ì´í„° ë³´ì¡´ ë° ë³µêµ¬ ê°€ëŠ¥

---

## ğŸ“š **7. ë§ˆë¬´ë¦¬**

- **JWT:** HttpOnly Secure ì¿ í‚¤ë¡œ ì•ˆì „í•˜ê²Œ ì €ì¥
- **Refresh Token:** Redisì— ì €ì¥í•˜ì—¬ ê²€ì¦ ë° ë¬´íš¨í™”
- **Redis ìš´ì˜:** TTL ê´€ë¦¬, ê°•ì œ ë¡œê·¸ì•„ì›ƒ, ì¼ì¼ ë°±ì—…

---

ì´ì œ ì„¤ê³„ ë° êµ¬í˜„ ê³„íšì´ ëª…í™•í•´ì¡ŒìŠµë‹ˆë‹¤. ğŸš€  
í˜¹ì‹œ ì¶”ê°€í•˜ê±°ë‚˜ ë³´ì™„í•  ë¶€ë¶„ì´ ìˆìœ¼ë©´ ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ˜ŠğŸ”¥